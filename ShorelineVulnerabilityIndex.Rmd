---
title: "ShorelineVulnerabilityIndex"
author: "Nicolas Sander"
date: "February 17th, 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Library, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

remove(list = ls(all.names = TRUE))
detachAllPackages <- function() {
  basic.packages.blank <-  c("stats", 
                             "graphics", 
                             "grDevices", 
                             "utils", 
                             "datasets", 
                             "methods", 
                             "base")
  basic.packages <- paste("package:", basic.packages.blank, sep = "")

  package.list <- search()[ifelse(unlist(gregexpr("package:", search())) == 1, 
                                  TRUE, 
                                  FALSE)]

  package.list <- setdiff(package.list, basic.packages)

  if (length(package.list) > 0)  for (package in package.list) {
    detach(package, character.only = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}
detachAllPackages()

using<-function(...) {
    libs<-unlist(list(...))
    req<-unlist(lapply(libs,require,character.only=TRUE))
    need<-libs[req==FALSE]
    if(length(need)>0){ 
        install.packages(need)
        lapply(need,require,character.only=TRUE)
    }
}
extrafont::loadfonts(device="win")
using("ggmap", "readxl", "sf", "arcgisbinding", "dplyr", "raster")
arc.check_product()

```

```{r Google API}
googleapikey <- rstudioapi::askForPassword()
register_google(key = googleapikey)
basemap_ba <- get_map(location=  c(-122.2913, 37.8272), zoom=10, maptype = 'satellite', source = 'google', color="bw")
```

```{r FEMA NFHL API Download, include = F, eval = F}
# open FEMA NFHL API (currently missing San Francisco '060298' data)
fema <- arc.open("https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/28")
# selecting data with Bay Area County codes
fema_st <- arc.select(fema, names(fema@fields), where_clause = "DFIRM_ID IN ('06001C', '06013C', '06055C', '06041C', '06085C', '06081C', '06095C', '06097C', '060298')")
# converting data to sf format
fema_st2 <- arc.data2sf(fema_st)
```

```{r Inputs}
# reading in FEMA Flood Hazard Layer Data for Bay Area
FEMA <- sf::st_read("./Inputs/Data/SVI_Inputs.gdb", layer = "FEMA_500yr100yrFlood_Region_201709") %>% st_transform(26910) %>% st_make_valid()
#ggmap::ggmap(basemap_ba) + geom_sf(data = FEMA, aes(color = FLD_AR_ID), inherit.aes = FALSE) + scale_color_viridis_c(option = "plasma", na.value = "white")

# reading in SFEI Shore Inventory Data for Bay Area
SFEI <- sf::st_read("./Inputs/Data/SVI_Inputs.gdb", layer = "San_Francisco_Bay_Shore_Inventory__100ft_segments_with_elevation") %>% st_transform(26910) %>% st_cast("MULTILINESTRING", "LINESTRING") %>% filter(Bayshore_Defense == "First line of shoreline defense")
#ggmap::ggmap(basemap_ba) + geom_sf(data = SFEI, aes(color = Segment_ID), inherit.aes = FALSE) + scale_color_viridis_c(option = "plasma", na.value = "white")

# reading in original Shoreline Vulnerability Index data, which includes manual identification of secondary shoreline defenses
SVI_6 <- sf::st_read("./Inputs/Data/SVI_Inputs.gdb", layer = "SVI_Final_6") %>% st_transform(26910)

# reading in Mean Higher High Water elevation for the Bay Area
MHHW <- as.raster(arc.raster(arc.open("./Inputs/Data/SVI_Inputs.gdb/NAVD88_MHHW1")))
MHHW <- projectRaster(MHHW, crs="+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs")
```

```{r Calculating SVI}
# project data based on SFEI Shore Inventory
data <- SFEI

# adding BCDC manual Secondary Shoreline attribute
data <- st_join(data, SVI_6 %>% dplyr::select(Second_Line = Second_Lin), largest = T)

# extracting mean MHHW values along SFEI Shoreline Inventory segments (Abby's old method used midpoints of each segment and assigned MHHW value)
SFEI_MHHW <- raster::extract(x=MHHW, y=SFEI, fun=mean, df=TRUE)
data$RASTERVALUE <- SFEI_MHHW$Band_1
data$Elev_Ft <- data$Z_Mean * 3.28084
data$Norm_Ratio <- data$Elev_Ft/data$RASTERVALUE

# filtering FEMA 100 year flood zone and joining to 50 meter buffered SFEI Shoreline inventory
FEMA100 <- FEMA %>% filter(FLD_ZONE != "X")
SFEI_FEMA100 <- st_join(st_buffer(data, 50), FEMA100, largest = T)
data <- st_join(data, dplyr::select(SFEI_FEMA100, c(FLD_ZONE, STATIC_BFE)), largest = T)

# dropping old SHAPE_Length attribute from SFEI
data <- data %>% dplyr::select(-SHAPE_Length)

# reclassify Transportation Structure to Major Road and Railroad
data <- data %>% mutate(Class = case_when(Class == "Transportation Structure" & Transportation_Type == "Major Road" ~ "Major Road",
                                     Class == "Transportation Structure" & Transportation_Type == "Rail" ~ "Railroad",
                                     TRUE ~ Class))

# classify attributes based on first survey weights (surveys included in ./Inputs folder)
data <- data %>% mutate(
                        #Survey Folder: Inputs/Surveys/Shoreline_Type_Survey
                        Baseline = case_when(Class == "Berm" ~ 32,
                                             Class == "Engineered Levee" ~ 5.8,
                                             Class == "Natural Shoreline" ~ 11.5,
                                             Class == "Shoreline Protection Structure" ~ 9.2,
                                             Class == "Major Road" ~ 19.7,
                                             Class == "Railroad" ~ 21.8,
                                             TRUE ~ NA_real_),
                        Baseline_Descriptive = ntile(Baseline, 5)) %>% mutate(Baseline_Descriptive = case_when(
                                                                                       Baseline_Descriptive == 1 ~ "Least Vulnerability",
                                                                                       Baseline_Descriptive == 2 ~ "Low Vulnerability",
                                                                                       Baseline_Descriptive == 3 ~ "Moderate Vulnerability",
                                                                                       Baseline_Descriptive == 4 ~ "High Vulnerability",
                                                                                       Baseline_Descriptive == 5 ~ "Highest Vulnerability",
                                                                                       TRUE ~ "NA"),
                        #Survey Folder: Inputs/Surveys/Adaptability_Survey, NOTE: values were flipped due to the inverse posing of the Adaptability question as "Which is more adaptable?" opposed to "Which is more vulnerable?" for the other factors
                        # Adaptability = case_when(Class == "Berm" ~ 17.6,
                        #                          Class == "Engineered Levee" ~ 20.0,
                        #                          Class == "Natural Shoreline" ~ 32.2,
                        #                          Class == "Shoreline Protection Structure" ~ 16.5,
                        #                          Class == "Major Road" ~ 7.5,
                        #                          Class == "Railroad" ~ 6.2,
                        #                          TRUE ~ NA_real_),
                        Adaptability = case_when(Class == "Berm" ~ 16.5,
                                                 Class == "Engineered Levee" ~ 7.5,
                                                 Class == "Natural Shoreline" ~ 6.2,
                                                 Class == "Shoreline Protection Structure" ~ 17.6,
                                                 Class == "Major Road" ~ 20.0,
                                                 Class == "Railroad" ~ 32.2,
                                                 TRUE ~ NA_real_),
                        Adaptability_Descriptive = ntile(Adaptability, 5)) %>% mutate(Adaptability_Descriptive = case_when(
                                                                                       Adaptability_Descriptive == 1 ~ "Highest Adaptability",
                                                                                       Adaptability_Descriptive == 2 ~ "High Adaptability",
                                                                                       Adaptability_Descriptive == 3 ~ "Moderate Adaptability",
                                                                                       Adaptability_Descriptive == 4 ~ "Low Adaptability",
                                                                                       Adaptability_Descriptive == 5 ~ "Least Adaptability",
                                                                                       TRUE ~ "NA"),
                        # Fortification = case_when(Class == "Berm" & Fortified == "Yes" ~ 12.3,
                        #                          Class == "Berm" & Fortified == "No" ~ 33.75,
                        #                          Class == "Engineered Levee" & Fortified == "Yes" ~ 10.1,
                        #                          Class == "Engineered Levee" & Fortified == "No" ~ 31.95,
                        #                          Class == "Natural Shoreline" & Fortified == "Yes" ~ 14.1,
                        #                          Class == "Natural Shoreline" & Fortified == "No" ~ 29.75,
                        #                          Class == "Shoreline Protection Structure" & Fortified == "Yes" ~ 11.3,
                        #                          Class == "Shoreline Protection Structure" & Fortified == "No" ~ 34.2,
                        #                          Class == "Major Road" & Fortified == "Yes" ~ 10.9,
                        #                          Class == "Major Road" & Fortified == "No" ~ 34.85,
                        #                          Class == "Railroad" & Fortified == "Yes" ~ 11.85,
                        #                          Class == "Railroad" & Fortified == "No" ~ 32.5,
                        #                          TRUE ~ NA_real_),
                        
                        #Survey Folder: Inputs/Surveys/Fortification_Survey
                        Fortification = case_when(Class == "Berm" & Fortified == "Maintained/Engineered" ~ 7.9,
                         Class == "Berm" & Fortified == "Yes" ~ 24.6,
                         Class == "Berm" & Fortified == "No" ~ 67.5,
                         Class == "Engineered Levee" & Fortified == "Maintained/Engineered" ~ 11.5,
                         Class == "Engineered Levee" & Fortified == "Yes" ~ 24.6,
                         Class == "Engineered Levee" & Fortified == "No" ~ 63.9,
                         Class == "Natural Shoreline" & Fortified == "Maintained/Engineered" ~ 12.4,
                         Class == "Natural Shoreline" & Fortified == "Yes" ~ 28.2,
                         Class == "Natural Shoreline" & Fortified == "No" ~ 59.5,
                         Class == "Shoreline Protection Structure" & Fortified == "Maintained/Engineered" ~ 8.9,
                         Class == "Shoreline Protection Structure" & Fortified == "Yes" ~ 22.6,
                         Class == "Shoreline Protection Structure" & Fortified == "No" ~ 68.4,
                         Class == "Major Road" & Fortified == "Maintained/Engineered" ~ 9.1,
                         Class == "Major Road" & Fortified == "Yes" ~ 21.8,
                         Class == "Major Road" & Fortified == "No" ~ 69.1,
                         Class == "Railroad" & Fortified == "Maintained/Engineered" ~ 11.3,
                         Class == "Railroad" & Fortified == "Yes" ~ 23.7,
                         Class == "Railroad" & Fortified == "No" ~ 65.0,
                         TRUE ~ NA_real_),
                        Fortification_Descriptive = ntile(Fortification, 5)) %>% mutate(Fortification_Descriptive = case_when(
                                                                                       Fortification_Descriptive == 1 ~ "Least Vulnerability",
                                                                                       Fortification_Descriptive == 2 ~ "Low Vulnerability",
                                                                                       Fortification_Descriptive == 3 ~ "Moderate Vulnerability",
                                                                                       Fortification_Descriptive == 4 ~ "High Vulnerability",
                                                                                       Fortification_Descriptive == 5 ~ "Highest Vulnerability",
                                                                                       TRUE ~ "NA"),
                        #No Survey, equally distributed weighting
                        Norm_Ratio_Classified = case_when(Norm_Ratio <= 1.17 ~ 29,
                                                          Norm_Ratio <= 1.33 ~ 24,
                                                          Norm_Ratio <= 1.5 ~ 19,
                                                          Norm_Ratio <= 1.75 ~ 14,
                                                          Norm_Ratio <= 2.08 ~ 9,
                                                          Norm_Ratio > 2.08 ~ 4,
                                                          TRUE ~ NA_real_),
                        Norm_Ratio_Descriptive = case_when(Norm_Ratio <= 1.17 ~ "12 inches above MHHW",
                                                          Norm_Ratio <= 1.33 ~ "12-24 inches above MHHW",
                                                          Norm_Ratio <= 1.5 ~ "24-36 inches above MHHW",
                                                          Norm_Ratio <= 1.75 ~ "36-54 inches above MHHW",
                                                          Norm_Ratio <= 2.08 ~ "54-78 inches above MHHW",
                                                          Norm_Ratio > 2.08 ~ "over 78 inches above MHHW",
                                                          TRUE ~ "NA"),
                        #No Survey, equally distributed weighting          
                        Wave_Energy = case_when(
                                                FLD_ZONE == 'AE' & STATIC_BFE == 9  ~ 4,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 10 ~ 4,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 11 ~ 9,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 12 ~ 9,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 13 ~ 9,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 14 ~ 9,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 9  ~ 14,   
                                                FLD_ZONE == 'VE' & STATIC_BFE == 10 ~ 14,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 11 ~ 14,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 12 ~ 14,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 13 ~ 19,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 14 ~ 19,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 15 ~ 24,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 16 ~ 24,
                                                FLD_ZONE == 'VE' & STATIC_BFE > 16 ~ 29,
                                                TRUE ~ NA_real_),
                        Wave_Energy_Descriptive = ntile(Wave_Energy, 5)) %>% mutate(Wave_Energy_Descriptive = case_when(
                                                                                       Wave_Energy_Descriptive == 1 ~ "Least Vulnerability",
                                                                                       Wave_Energy_Descriptive == 2 ~ "Low Vulnerability",
                                                                                       Wave_Energy_Descriptive == 3 ~ "Moderate Vulnerability",
                                                                                       Wave_Energy_Descriptive == 4 ~ "High Vulnerability",
                                                                                       Wave_Energy_Descriptive == 5 ~ "Highest Vulnerability",
                                                                                       TRUE ~ "NA"),
                        #Survey Folder: Inputs/Surveys/Frontage_Survey
                        Frontage_SecondLine = case_when(
                                Class == 'Berm' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 5.2,
                                Class == 'Berm' & Frontage == 'Beach' & Second_Line == 'No'  ~ 15.1,
                                Class == 'Berm' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 4.6,
                                Class == 'Berm' & Frontage == 'Wetland' & Second_Line == 'No' ~ 11.6,
                                Class == 'Berm' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 3.1,
                                Class == 'Berm' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 7.1,
                                Class == 'Berm' & Frontage == 'None' & Second_Line == 'Yes' ~ 15.0,
                                Class == 'Berm' & Frontage == 'None' & Second_Line == 'No' ~ 38.3,
                                Class == 'Engineered Levee' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 5.1,
                                Class == 'Engineered Levee' & Frontage == 'Beach' & Second_Line == 'No' ~ 14.8,
                                Class == 'Engineered Levee' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 4.0,
                                Class == 'Engineered Levee' & Frontage == 'Wetland' & Second_Line == 'No' ~ 11.8,
                                Class == 'Engineered Levee' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 3.1,
                                Class == 'Engineered Levee' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 7.7,
                                Class == 'Engineered Levee' & Frontage == 'None' & Second_Line == 'Yes' ~ 14.5,
                                Class == 'Engineered Levee' & Frontage == 'None' & Second_Line == 'No' ~ 39.0,
                                Class == 'Natural Shoreline' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 4.5,
                                Class == 'Natural Shoreline' & Frontage == 'Beach' & Second_Line == 'No' ~ 15.9,
                                Class == 'Natural Shoreline' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 3.6,
                                Class == 'Natural Shoreline' & Frontage == 'Wetland' & Second_Line == 'No' ~ 11.6,
                                Class == 'Natural Shoreline' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.8,
                                Class == 'Natural Shoreline' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 8.0,
                                Class == 'Natural Shoreline' & Frontage == 'None' & Second_Line == 'Yes' ~ 13.1,
                                Class == 'Natural Shoreline' & Frontage == 'None' & Second_Line == 'No' ~ 40.5,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 4.8,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach' & Second_Line == 'No' ~ 16.1,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 4.2,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Wetland' & Second_Line == 'No' ~ 12.8,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.9,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 8.5,
                                Class == 'Shoreline Protection Structure' & Frontage == 'None' & Second_Line == 'Yes' ~ 11.9,
                                Class == 'Shoreline Protection Structure' & Frontage == 'None' & Second_Line == 'No'~ 38.8,
                                Class == 'Major Road' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 5.0,
                                Class == 'Major Road' & Frontage == 'Beach' & Second_Line == 'No' ~ 15.8,
                                Class == 'Major Road' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 4.0,
                                Class == 'Major Road' & Frontage == 'Wetland' & Second_Line == 'No' ~ 11.8,
                                Class == 'Major Road' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 3.2,
                                Class == 'Major Road' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 8.3,
                                Class == 'Major Road' & Frontage == 'None' & Second_Line == 'Yes' ~ 13.0,
                                Class == 'Major Road' & Frontage == 'None' & Second_Line == 'No' ~ 38.9,
                                Class == 'Railroad' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 4.9,
                                Class == 'Railroad' & Frontage == 'Beach' & Second_Line == 'No' ~ 16.8,
                                Class == 'Railroad' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 4.1,
                                Class == 'Railroad' & Frontage == 'Wetland' & Second_Line == 'No' ~ 12.2,
                                Class == 'Railroad' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 3.1,
                                Class == 'Railroad' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 8.4,
                                Class == 'Railroad' & Frontage == 'None' & Second_Line == 'Yes' ~ 12.4,
                                Class == 'Railroad' & Frontage == 'None' & Second_Line == 'No' ~ 38.1,
                                TRUE ~ NA_real_
                                            ),
                        Frontage_SecondLine_Descriptive = ntile(Frontage_SecondLine, 5)) %>% mutate(Frontage_SecondLine_Descriptive = case_when(
                                                                                       Frontage_SecondLine_Descriptive == 1 ~ "Least Vulnerability",
                                                                                       Frontage_SecondLine_Descriptive == 2 ~ "Low Vulnerability",
                                                                                       Frontage_SecondLine_Descriptive == 3 ~ "Moderate Vulnerability",
                                                                                       Frontage_SecondLine_Descriptive == 4 ~ "High Vulnerability",
                                                                                       Frontage_SecondLine_Descriptive == 5 ~ "Highest Vulnerability",
                                                                                       TRUE ~ "NA")
                        )

# final SVI score as a sum of attributes, eachh multiplied by relative weights from second survey (surveys included in ./Inputs folder)
#Survey Folder: Inputs/Surveys/Engineer_Survey
data <- data %>% mutate(SVI = case_when(Class == "Berm" ~ Baseline * 11.4 + Adaptability * 8.2 + Fortification * 6.2 + Norm_Ratio_Classified * 20.1 + Wave_Energy * 49.8 + Frontage_SecondLine * 4.3,
                                        Class == "Engineered Levee" ~ Baseline * 7.3 + Adaptability * 12.8 + Fortification * 8.1 + Norm_Ratio_Classified * 33.5 + Wave_Energy * 33.0 + Frontage_SecondLine * 5.3,
                                        Class == "Natural Shoreline" ~ Baseline * 10.4 + Adaptability * 8.4 + Fortification * 6.0 + Norm_Ratio_Classified * 20.7 + Wave_Energy * 50.1 + Frontage_SecondLine * 4.4,
                                        Class == "Shoreline Protection Structure" ~ Baseline * 6.8 + Adaptability * 12.6 + Fortification * 10.0 + Norm_Ratio_Classified * 32.3 + Wave_Energy * 32.8 + Frontage_SecondLine * 5.5,
                                        Class == "Major Road" ~ Baseline * 6.2 + Adaptability * 6.3 + Fortification * 8.3 + Norm_Ratio_Classified * 36.0 + Wave_Energy * 37.3 + Frontage_SecondLine * 5.9,
                                        Class == "Railroad" ~ Baseline * 6.0 + Adaptability * 6.2 + Fortification * 10.3 + Norm_Ratio_Classified * 27.8 + Wave_Energy * 43.7 + Frontage_SecondLine * 6.0,
                                        TRUE ~ NA_real_)
                        )

# adding score binning based on 5 quantiles
data <- data %>% mutate(SVI_Rank = ntile(SVI, 5)) %>% mutate(SVI_Rank = case_when(SVI_Rank == 1 ~ "Least Vulnerability",
                                                                                       SVI_Rank == 2 ~ "Low Vulnerability",
                                                                                       SVI_Rank == 3 ~ "Moderate Vulnerability",
                                                                                       SVI_Rank == 4 ~ "High Vulnerability",
                                                                                       SVI_Rank == 5 ~ "Highest Vulnerability",
                                                                                       TRUE ~ "NA")
                                                            )

#saving as ESRI .gdb in ./Outputs
arcgisbinding::arc.write(paste0("./Outputs/SVI_Outputs.gdb/ShorelineVulnerabilityIndex_",format(as.Date(Sys.Date()), "%d_%m_%Y")), st_transform(data, 26910),  shape_info=list(type='Polyline',WKID=26910))

# reading in output data for testing
#data <- sf::st_read("./Outputs/SVI_Outputs.gdb")
```