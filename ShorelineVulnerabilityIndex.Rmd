---
title: "ShorelineVulnerabilityIndex"
author: "Nicolas Sander"
date: "August 3, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Library, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

remove(list = ls(all.names = TRUE))
detachAllPackages <- function() {
  basic.packages.blank <-  c("stats", 
                             "graphics", 
                             "grDevices", 
                             "utils", 
                             "datasets", 
                             "methods", 
                             "base")
  basic.packages <- paste("package:", basic.packages.blank, sep = "")

  package.list <- search()[ifelse(unlist(gregexpr("package:", search())) == 1, 
                                  TRUE, 
                                  FALSE)]

  package.list <- setdiff(package.list, basic.packages)

  if (length(package.list) > 0)  for (package in package.list) {
    detach(package, character.only = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}
detachAllPackages()

using<-function(...) {
    libs<-unlist(list(...))
    req<-unlist(lapply(libs,require,character.only=TRUE))
    need<-libs[req==FALSE]
    if(length(need)>0){ 
        install.packages(need)
        lapply(need,require,character.only=TRUE)
    }
}
extrafont::loadfonts(device="win")
using("ggmap", "readxl", "sf", "arcgisbinding", "dplyr", "raster")
arc.check_product()

```

```{r Google API}
googleapikey <- rstudioapi::askForPassword()
register_google(key = googleapikey)
basemap_ba <- get_map(location=  c(-122.2913, 37.8272), zoom=10, maptype = 'satellite', source = 'google', color="bw")
```

```{r Inputs}
FEMA <- sf::st_read("./Inputs/Data/SVI.gdb", layer = "FEMA_500yr100yrFlood_Region_201709") %>% st_transform(26910) %>% st_make_valid()
#ggmap::ggmap(basemap_ba) + geom_sf(data = FEMA, aes(color = FLD_AR_ID), inherit.aes = FALSE) + scale_color_viridis_c(option = "plasma", na.value = "white")

SFEI <- sf::st_read("./Inputs/Data/SVI.gdb", layer = "San_Francisco_Bay_Shore_Inventory__100ft_segments_with_elevation") %>% st_transform(26910) %>% st_cast("MULTILINESTRING", "LINESTRING")
SFEI <- SFEI %>% filter(Bayshore_Defense == "First line of shoreline defense")
#ggmap::ggmap(basemap_ba) + geom_sf(data = SFEI, aes(color = Segment_ID), inherit.aes = FALSE) + scale_color_viridis_c(option = "plasma", na.value = "white")

MHHW <- as.raster(arc.raster(arc.open("./Inputs/Data/SVI.gdb/NAVD88_MHHW1")))
MHHW <- projectRaster(MHHW, crs="+proj=utm +zone=10 +datum=NAD83 +units=m +no_defs")
```

```{r Calculating SVI}
# load packages
library(sf) # Simple Features for R
library(rnaturalearth) # World Map Data from Natural Earth
library(here) # A Simpler Way to Find Your Files
library(stars) # Spatiotemporal Arrays, Raster and Vector Data Cubes
library(dplyr) # A Grammar of Data Manipulation
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggnewscale) # Multiple Fill and Color Scales in 'ggplot2'
library(scico) # Colour Palettes Based on the Scientific Colour-Maps
library(geobgu) # install from GitHub ("michaeldorman/geobgu")
library(ggrepel) # Automatically Position Non-Overlapping Text Labels with 'ggplot2'

#project data based on SFEI Shoreline Inventory
data <- SFEI

#adding BCDC manual Secondary Shoreline attribute
data <- st_join(data, SVI_6 %>% dplyr::select(Second_Line = Second_Lin), largest = T)

#extracting mean MHHW values along SFEI Shoreline Inventory segments (Abby's old method used midpoints of each segment and assigned MHHW value)
SFEI_MHHW <- raster::extract(x=MHHW, y=SFEI, fun=mean, df=TRUE)
data$RASTERVALUE <- SFEI_MHHW$Band_1
data$Elev_Ft <- data$Z_Mean * 3.28084
data$Norm_Ratio <- data$Elev_Ft/data$RASTERVALUE

#filtering FEMA 100 year flood zone and joining to 50 meter buffered SFEI Shoreline inventory
FEMA100 <- FEMA %>% filter(FLD_ZONE != "X")
SFEI_FEMA100 <- st_join(st_buffer(data, 50), FEMA100, largest = T)
data <- st_join(data, dplyr::select(SFEI_FEMA100, c(FLD_ZONE, STATIC_BFE)), largest = T)

#dropping old SHAPE_Length attribute from SFEI
data <- data %>% dplyr::select(-SHAPE_Length)

#reclassify Transportation Structure to Major Road and Railroad
data <- data %>% mutate(Class = case_when(Class == "Transportation Structure" & Transportation_Type == "Major Road" ~ "Major Road",
                                     Class == "Transportation Structure" & Transportation_Type == "Rail" ~ "Railroad",
                                     TRUE ~ Class))

data <- data %>% mutate(Baseline = case_when(Class == "Berm" ~ 32,
                                             Class == "Engineered Levee" ~ 5.8,
                                             Class == "Natural Shoreline" ~ 11.5,
                                             Class == "Shoreline Protection Structure" ~ 9.2,
                                             Class == "Major Road" ~ 19.7,
                                             Class == "Railroad" ~ 21.8,
                                             TRUE ~ NA_real_),
                        Adaptability = case_when(Class == "Berm" ~ 16.5,
                                                 Class == "Engineered Levee" ~ 7.5,
                                                 Class == "Natural Shoreline" ~ 6.2,
                                                 Class == "Shoreline Protection Structure" ~ 17.6,
                                                 Class == "Major Road" ~ 20,
                                                 Class == "Railroad" ~ 32.2,
                                                 TRUE ~ NA_real_),
                        Fortification = case_when(Class == "Berm" & Fortified == "Yes" ~ 12.3,
                                                 Class == "Berm" & Fortified == "No" ~ 33.75,
                                                 Class == "Engineered Levee" & Fortified == "Yes" ~ 10.1,
                                                 Class == "Engineered Levee" & Fortified == "No" ~ 31.95,
                                                 Class == "Natural Shoreline" & Fortified == "Yes" ~ 14.1,
                                                 Class == "Natural Shoreline" & Fortified == "No" ~ 29.75,
                                                 Class == "Shoreline Protection Structure" & Fortified == "Yes" ~ 11.3,
                                                 Class == "Shoreline Protection Structure" & Fortified == "No" ~ 34.2,
                                                 Class == "Major Road" & Fortified == "Yes" ~ 10.9,
                                                 Class == "Major Road" & Fortified == "No" ~ 34.85,
                                                 Class == "Railroad" & Fortified == "Yes" ~ 11.85,
                                                 Class == "Railroad" & Fortified == "No" ~ 32.5,
                                                 TRUE ~ NA_real_),
                        Norm_Ratio_Classified = case_when(Norm_Ratio <= 1.17 ~ 29,
                                                          Norm_Ratio <= 1.33 ~ 24,
                                                          Norm_Ratio <= 1.5 ~ 19,
                                                          Norm_Ratio <= 1.75 ~ 14,
                                                          Norm_Ratio <= 2.08 ~ 9,
                                                          Norm_Ratio > 2.08 ~ 4,
                                                          TRUE ~ NA_real_),
                        Norm_Ratio_Descriptive = case_when(Norm_Ratio <= 1.17 ~ "12 inches above MHHW",
                                                          Norm_Ratio <= 1.33 ~ "12-24 inches above MHHW",
                                                          Norm_Ratio <= 1.5 ~ "24-36 inches above MHHW",
                                                          Norm_Ratio <= 1.75 ~ "36-54 inches above MHHW",
                                                          Norm_Ratio <= 2.08 ~ "54-78 inches above MHHW",
                                                          Norm_Ratio > 2.08 ~ "over 78 inches above MHHW",
                                                          TRUE ~ "NA"),
                                  Wave_Energy = case_when(
                                                FLD_ZONE == 'AE' & STATIC_BFE == 9  ~ 4,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 10 ~ 4,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 11 ~ 9,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 12 ~ 9,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 13 ~ 9,
                                                FLD_ZONE == 'AE' & STATIC_BFE == 14 ~ 9,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 9  ~ 14,   
                                                FLD_ZONE == 'VE' & STATIC_BFE == 10 ~ 14,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 11 ~ 14,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 12 ~ 14,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 13 ~ 19,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 14 ~ 19,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 15 ~ 24,
                                                FLD_ZONE == 'VE' & STATIC_BFE == 16 ~ 24,
                                                FLD_ZONE == 'VE' & STATIC_BFE >16 ~ 29,
                                                TRUE ~ NA_real_),
                        Frontage_SecondLine = case_when(
                                Class == 'Berm' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 3.9,
                                Class == 'Berm' & Frontage == 'Beach' & Second_Line == 'No'  ~ 11.325,
                                Class == 'Berm' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 3.45,
                                Class == 'Berm' & Frontage == 'Wetland' & Second_Line == 'No' ~ 8.7,
                                Class == 'Berm' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.325,
                                Class == 'Berm' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 5.325,
                                Class == 'Berm' & Frontage == 'None' & Second_Line == 'Yes' ~ 11.25,
                                Class == 'Berm' & Frontage == 'None' & Second_Line == 'No' ~ 28.725,
                                Class == 'Engineered Levee' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 3.825,
                                Class == 'Engineered Levee' & Frontage == 'Beach' & Second_Line == 'No' ~ 11.1,
                                Class == 'Engineered Levee' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 3,
                                Class == 'Engineered Levee' & Frontage == 'Wetland' & Second_Line == 'No' ~ 8.85,
                                Class == 'Engineered Levee' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.325,
                                Class == 'Engineered Levee' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 5.775,
                                Class == 'Engineered Levee' & Frontage == 'None' & Second_Line == 'Yes' ~ 10.875,
                                Class == 'Engineered Levee' & Frontage == 'None' & Second_Line == 'No' ~ 29.25,
                                Class == 'Natural Shoreline' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 3.375,
                                Class == 'Natural Shoreline' & Frontage == 'Beach' & Second_Line == 'No' ~ 11.925,
                                Class == 'Natural Shoreline' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 2.7,
                                Class == 'Natural Shoreline' & Frontage == 'Wetland' & Second_Line == 'No' ~ 8.7,
                                Class == 'Natural Shoreline' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.1,
                                Class == 'Natural Shoreline' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 6,
                                Class == 'Natural Shoreline' & Frontage == 'None' & Second_Line == 'Yes' ~ 9.825,
                                Class == 'Natural Shoreline' & Frontage == 'None' & Second_Line == 'No' ~ 30.375,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 3.375,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach' & Second_Line == 'No' ~ 12.075,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 3.15,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Wetland' & Second_Line == 'No' ~ 9.6,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.175,
                                Class == 'Shoreline Protection Structure' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 6.375,
                                Class == 'Shoreline Protection Structure' & Frontage == 'None' & Second_Line == 'Yes' ~ 8.925,
                                Class == 'Shoreline Protection Structure' & Frontage == 'None' & Second_Line == 'No'~ 29.1,
                                Class == 'Major Road' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 3.75,
                                Class == 'Major Road' & Frontage == 'Beach' & Second_Line == 'No' ~ 11.85,
                                Class == 'Major Road' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 3,
                                Class == 'Major Road' & Frontage == 'Wetland' & Second_Line == 'No' ~ 8.85,
                                Class == 'Major Road' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.4,
                                Class == 'Major Road' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 6.225,
                                Class == 'Major Road' & Frontage == 'None' & Second_Line == 'Yes' ~ 9.75,
                                Class == 'Major Road' & Frontage == 'None' & Second_Line == 'No' ~ 29.175,
                                Class == 'Railroad' & Frontage == 'Beach' & Second_Line == 'Yes' ~ 3.675,
                                Class == 'Railroad' & Frontage == 'Beach' & Second_Line == 'No' ~ 12.6,
                                Class == 'Railroad' & Frontage == 'Wetland' & Second_Line == 'Yes' ~ 3.075,
                                Class == 'Railroad' & Frontage == 'Wetland' & Second_Line == 'No' ~ 9.15,
                                Class == 'Railroad' & Frontage == 'Beach and Wetland' & Second_Line == 'Yes' ~ 2.325,
                                Class == 'Railroad' & Frontage == 'Beach and Wetland' & Second_Line == 'No' ~ 6.3,
                                Class == 'Railroad' & Frontage == 'None' & Second_Line == 'Yes' ~ 9.3,
                                Class == 'Railroad' & Frontage == 'None' & Second_Line == 'No' ~ 28.575,
                                TRUE ~ NA_real_
                                            )
                        )


data <- data %>% mutate(SVI = case_when(Class == "Berm" ~ Baseline * 11.4 + Adaptability * 8.2 + Fortification * 6.2 + Norm_Ratio_Classified * 20.1 + Wave_Energy * 49.8 + Frontage_SecondLine * 4.3,
                                        Class == "Engineered Levee" ~ Baseline * 7.3 + Adaptability * 12.8 + Fortification * 8.6 + Norm_Ratio_Classified * 34.7 + Wave_Energy * 31.1 + Frontage_SecondLine * 5.5,
                                        Class == "Natural Shoreline" ~ Baseline * 10.4 + Adaptability * 8.4 + Fortification * 6.0 + Norm_Ratio_Classified * 20.7 + Wave_Energy * 50.1 + Frontage_SecondLine * 4.4,
                                        Class == "Shoreline Protection Structure" ~ Baseline * 6.8 + Adaptability * 12.6 + Fortification * 10.0 + Norm_Ratio_Classified * 32.3 + Wave_Energy * 32.8 + Frontage_SecondLine * 5.5,
                                        Class == "Major Road" ~ Baseline * 6.2 + Adaptability * 6.3 + Fortification * 8.3 + Norm_Ratio_Classified * 36.0 + Wave_Energy * 37.3 + Frontage_SecondLine * 5.9,
                                        Class == "Railroad" ~ Baseline * 6.0 + Adaptability * 6.2 + Fortification * 10.3 + Norm_Ratio_Classified * 27.8 + Wave_Energy * 43.7 + Frontage_SecondLine * 6.0,
                                        TRUE ~ NA_real_)
                        )

#saving as ESRI .gdb
arcgisbinding::arc.write(paste0("./Outputs/SVI.gdb/ShorelineVulnerabilityIndex_",format(as.Date(Sys.Date()), "%d_%m_%Y")), st_transform(data, 26910),  shape_info=list(type='Polyline',WKID=26910))

#data <- sf::st_read("~Output/SVI.gdb")
```

```{r Test & Diagnosis}
fema <- arc.open("https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/28")
fema_st <- arc.select(fema, names(fema@fields), where_clause = "DFIRM_ID IN ('06001C', '06013C', '06055C', '06041C', '06085C', '06081C', '06095C', '06097C', '060298')")
fema_st2 <- arc.data2sf(fema_st)
fema_sf <- arc.select(fema, names(fema@fields), where_clause = "DFIRM_ID IN ('060298')")

test <- st_join(data, SVI_6 %>% dplyr::select(Second_Line = Second_Lin), largest = T)
test <- test %>% mutate(BASELINE = Baseline.x - Baseline.y,
                        ADPT = Adaptability - Adaptabili,
                        FRT = Fortification - Fortificat,
                        NRM_R_C = Norm_Ratio_Classified - Norm_Elev,
                        WAV = Wave_Energy - Wave_Energ,
                        FRNT = Frontage_Class - FRONT_SECO,
                        SVI_COMP = SVI.x - SVI.y)

abby <- SVI_6 %>% mutate(SVI_Calc = case_when(Class == "Berm" ~ Baseline * 11.4 + Adaptabili * 8.2 + Fortificat * 6.2 + Norm_Elev * 20.1 + Wave_Energ * 49.8 + FRONT_SECO * 4.3,
                                        Class == "Engineered Levee" ~ Baseline * 7.3 + Adaptabili * 12.8 + Fortificat * 8.6 + Norm_Elev * 34.7 + Wave_Energ * 31.1 + FRONT_SECO * 5.5,
                                        Class == "Natural Shoreline" ~ Baseline * 10.4 + Adaptabili * 8.4 + Fortificat * 6.0 + Norm_Elev * 20.7 + Wave_Energ * 50.1 + FRONT_SECO * 4.4,
                                        Class == "Shoreline Protection Structure" ~ Baseline * 6.8 + Adaptabili * 12.6 + Fortificat * 10.0 + Norm_Elev * 32.3 + Wave_Energ * 32.8 + FRONT_SECO * 5.5,
                                        Class == "Major Road" ~ Baseline * 6.2 + Adaptabili * 6.3 + Fortificat * 8.3 + Norm_Elev * 36.0 + Wave_Energ * 37.3 + FRONT_SECO * 5.9,
                                        Class == "Railroad" ~ Baseline * 6.0 + Adaptabili * 6.2 + Fortificat * 10.3 + Norm_Elev * 27.8 + Wave_Energ * 43.7 + FRONT_SECO * 6.0,
                                        TRUE ~ NA_real_))
abby <- abby %>% mutate(SVI_Diff = SVI - SVI_Calc) %>% dplyr::select(c(Segment_ID, Baseline, Adaptabili, Fortificat, Norm_Elev, Wave_Energ, FRONT_SECO, SVI, SVI_Calc, SVI_Diff))
length(which(abby$SVI_Diff < 1 & abby$SVI_Diff > -1))

model <- lm(SVI_Diff ~ Baseline + Adaptabili + Fortificat + Norm_Elev + Wave_Energ + FRONT_SECO, data = abby)
```